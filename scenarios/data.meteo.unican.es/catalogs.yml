- name: Create common content/thredds directory
  file: state=directory path={{ tomcat_home }}/content

- name: Checkout TDS5 data
  subversion:
    repo: https://meteo.unican.es/svn/repos/sistemas/services/TDS5/tomcat/content/thredds/
    dest: "{{ tds_content }}"
    username: "{{ svn_username }}"
    password: "{{ svn_password }}"
    force: yes
  run_once: True

- name: Fix TDS5 catalogs and datasets (remove tabs)
  shell: find catalogs public -type f -print0 | xargs -0 -n1 | grep -v svn | xargs -n1 perl -pi -e 's/(".*?)\t+"/\1"/g'
  args:
    chdir: "{{ tds_content }}"
  run_once: True

- name: Reference ESGF catalog from TDS5 root catalog
  lineinfile:
    path: "{{ tds_content }}/catalog.xml"
    insertbefore: </catalog>
    line: '<catalogRef xlink:title="Unican ESGF Data Node" xlink:href="esgcet/catalog.xml" name="" />'
  run_once: True


## Temporary cmip6 catalog
- name: Copy cmip6 catalog
  copy: src=cmip6.xml dest={{ tds_content }}/catalogs/cmip6.xml
  run_once: True
  
- name: Reference cmip6 catalog
  lineinfile:
    path: "{{ tds_content }}/catalog.xml"
    insertbefore: </catalog>
    line: '<catalogRef xlink:title="CMIP6" xlink:href="catalogs/cmip6.xml" name="" />'
  run_once: True
